"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),C=require("@/config"),F=require("./useUploadUtils.js"),U={class:"cd-upload-wrap"},$={class:"cd-upload-wrap-cont"},v={class:"cd-upload-wrap-btns"},N=e.defineComponent({__name:"UploadBtn",props:{formObj:{default:()=>({})},uploadUrl:{default:"/api/equipment-documents/attachments"},accept:{default:""},format:{default:()=>[]},itemcode:{default:""},multiple:{type:Boolean,default:!1},maxSize:{default:"auto"},seletLastTitle:{type:Boolean,default:!1},isOss:{type:Boolean,default:!1},beforeUploadHandle:{type:Function,default:()=>!0}},emits:["on-cancel"],setup(d,{emit:r}){const l=d,s=e.reactive({files:[],successFiles:[],failFiels:[],loading:!1,ossInstance:null,ossConfig:null}),u=e.computed(()=>s.files.length>0?l.multiple?`已选择${s.files.length}个文件，继续添加或点击上传`:`已选择${s.files.length}个文件，请点击上传`:"点击选择文件"),p=t=>{const n=t.name.split(".")[1];return l.format.length>0&&!l.format.includes(n)?(window.$Message.warning(`请选择后缀为${l.format.join("，")}的文件`),!1):l.maxSize!=="auto"&&t.size>l.maxSize?(window.$Message.warning(`选择的文件大小不能超过${+l.maxSize/1e4}M`),!1):(l.multiple?s.files.push(t):s.files=[t],!1)},f=async()=>{if(l.beforeUploadHandle()){if(s.loading=!0,!s.files.length)return s.loading=!1,window.$Message.warning("请选择文件");if(l.seletLastTitle&&!l.formObj.attitle)return s.loading=!1,window.$Message.warning("附件标题需选到最后一级");s.successFiles=[],s.failFiels=[];for(let t of s.files)h({...l.formObj,file:t})}},{initOSS:m,uploadByOSS:g,uploadRequest:w}=F.default(),_=e.inject("onUploadSuccessHandle"),h=async t=>{let n=t;if(C.FzIsOss==="oss"||l.isOss){if(s.ossInstance===null){const o=await m({itemcode:l.itemcode});s.ossInstance=o.ossInstance,s.ossConfig=o.config}n=await g(s.ossInstance,s.ossConfig,t)}try{const o=await w(n,l.uploadUrl),{isSuccess:a,errorMsg:i,errmsg:c}=o.data||{};a===!1||a==="false"?(window.$Message.error(`上传失败:${i||c}`),s.failFiels.push(t)):(s.successFiles.push(t),s.failFiels.length+s.successFiles.length===s.files.length&&(window.$Message.success("上传成功"),_(s.successFiles),r("on-cancel")))}catch(o){window.$Message.error(`上传失败:${o}`)}s.loading=!1},y=t=>{s.files.splice(t,1)},S=()=>{r("on-cancel")};return(t,n)=>{const o=e.resolveComponent("Icon"),a=e.resolveComponent("Upload"),i=e.resolveComponent("Button");return e.openBlock(),e.createElementBlock("div",U,[e.createVNode(a,{type:"drag",multiple:t.multiple,accept:t.accept,"before-upload":p,action:""},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(o,{type:"ios-cloud-upload",size:"80",style:{color:"#3399ff"}}),e.createElementVNode("p",null,e.toDisplayString(u.value),1)])]),_:1},8,["multiple","accept"]),e.createElementVNode("div",$,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.files,(c,B)=>(e.openBlock(),e.createElementBlock("p",{class:"cd-upload-wrap-cont-item",key:B},[e.createElementVNode("span",null,e.toDisplayString(c.name),1),e.createVNode(o,{class:"close",type:"ios-close",size:"24",onClick:y})]))),128))]),e.createElementVNode("div",v,[e.createVNode(i,{class:"btn-l",type:"primary",loading:s.loading,onClick:f},{default:e.withCtx(()=>[e.createTextVNode("上传")]),_:1},8,["loading"]),e.createVNode(i,{class:"btn-r",onClick:S},{default:e.withCtx(()=>[e.createTextVNode("取消")]),_:1})])])}}});exports.default=N;
